import json

def _json_load_if_needed(x):
    """If x is a JSON string, parse it; otherwise return as-is."""
    if isinstance(x, str):
        x = x.strip()
        if (x.startswith("{") and x.endswith("}")) or (x.startswith("[") and x.endswith("]")):
            try:
                return json.loads(x)
            except Exception:
                return x
    return x

def _resp(req, result=None, error=None):
    """Return JSON-RPC 2.0 style response."""
    base = {
        "jsonrpc": "2.0",
        "id": req.get("id"),
    }
    if error is not None:
        base["error"] = error
    else:
        base["result"] = result or {}
    return base

def _extract_request(event):
    """
    Gateways sometimes wrap JSON-RPC in 'body' or pass it directly.
    Normalize into a dict with keys: jsonrpc, id, method, params.
    """
    if isinstance(event, dict) and "body" in event and isinstance(event["body"], str):
        try:
            return json.loads(event["body"])
        except Exception:
            return event
    return event

def _extract_input(params):
    """
    Normalize tool call input. Accepts:
      params.arguments, params.input, params.payload
    and supports those being dict OR JSON string.
    """
    if not isinstance(params, dict):
        return {}

    for key in ("arguments", "input", "payload"):
        if key in params and params[key] is not None:
            val = _json_load_if_needed(params[key])
            if isinstance(val, dict):
                return val

    return {}

def _is_process_refund_tool(name: str) -> bool:
    """
    Your gateway tool name is like: target-quick-start-6bd74e__process_refund
    So accept:
      - exact "process_refund"
      - anything ending with "__process_refund"
    """
    if not name:
        return False
    return name == "process_refund" or name.endswith("__process_refund")

def lambda_handler(event, context):
    # Helpful debug (check CloudWatch logs if something still looks off)
    req = _extract_request(event)
    print("RAW_EVENT:", json.dumps(event))
    print("NORMALIZED_REQ:", json.dumps(req))

    method = req.get("method")
    params = req.get("params") or {}
    params = _json_load_if_needed(params) if isinstance(params, str) else params

    # 1) tools/list -> return the tools this target provides
    if method == "tools/list":
        tools = [
            {
                "name": "process_refund",
                "description": "Process a refund request",
                "inputSchema": {
                    "type": "object",
                    "properties": {
                        "amount": {"type": "integer", "description": "Refund amount"},
                        "reason": {"type": "string", "description": "Reason for refund"},
                    },
                    "required": ["amount", "reason"],
                },
            }
        ]
        return _resp(req, result={"tools": tools})

    # 2) tools/call -> execute a tool
    if method == "tools/call":
        # Tool name may be passed in params.name
        name = None
        if isinstance(params, dict):
            name = params.get("name")

        # Validate tool name (allow suffix form)
        if not _is_process_refund_tool(name):
            return _resp(req, error={"code": -32601, "message": f"Unknown tool: {name}"})

        tool_input = _extract_input(params)
        print("TOOL_INPUT:", json.dumps(tool_input))

        amount = tool_input.get("amount")
        reason = tool_input.get("reason")

        missing = []
        if amount is None:
            missing.append("amount")
        if reason is None:
            missing.append("reason")

        if missing:
            return _resp(
                req,
                error={
                    "code": -32602,
                    "message": f"Invalid request parameters: Missing required field(s): {', '.join(missing)}"
                },
            )

        # Success payload (your agent/gateway client will see this as the tool result)
        return _resp(
            req,
            result={
                "content": [
                    {
                        "type": "text",
                        "text": json.dumps(
                            {
                                "status": "OK",
                                "amount": amount,
                                "reason": reason,
                                "message": "Refund processed",
                            }
                        ),
                    }
                ]
            },
        )

    # Anything else
    return _resp(req, error={"code": -32601, "message": f"Unknown method: {method}"})
