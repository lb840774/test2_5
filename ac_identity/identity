import os, json, uuid
import boto3
from botocore.exceptions import ClientError

REGION = os.environ.get("AWS_REGION", "us-east-1")
sess = boto3.session.Session(region_name=REGION)

# control-plane client
ctrl = sess.client("bedrock-agentcore-control")

# data-plane client (identity runtime calls)
dp = sess.client("bedrock-agentcore")

print("REGION:", REGION)
print("control:", ctrl.meta.service_model.service_name)
print("dataplane:", dp.meta.service_model.service_name)



WORKLOAD_NAME = f"wid-nb-{uuid.uuid4().hex[:8]}"

try:
    wid_resp = ctrl.create_workload_identity(
        name=WORKLOAD_NAME,
        description="Standalone workload identity for MCP Gateway + Lambda test"
    )
    print("✅ Created workload identity:", WORKLOAD_NAME)
    print(json.dumps(wid_resp, indent=2, default=str)[:2000])
except ClientError as e:
    print("❌ create_workload_identity failed:", e.response["Error"]["Code"], e.response["Error"].get("Message"))
    raise



API_KEY_VALUE = "demo-secret-123"  # just a test value
APIKEY_PROVIDER_NAME = f"demo-apikey-{uuid.uuid4().hex[:8]}"

try:
    pk_resp = ctrl.create_api_key_credential_provider(
        name=APIKEY_PROVIDER_NAME,
        apiKey=API_KEY_VALUE
    )
    print("✅ Created API key credential provider:", APIKEY_PROVIDER_NAME)
    print(json.dumps(pk_resp, indent=2, default=str)[:2000])
except ClientError as e:
    print("❌ create_api_key_credential_provider failed:", e.response["Error"]["Code"], e.response["Error"].get("Message"))
    raise



print("=== COPY THESE INTO LAMBDA ENV VARS ===")
print("AWS_REGION =", REGION)
print("WORKLOAD_NAME =", WORKLOAD_NAME)
print("APIKEY_PROVIDER_NAME =", APIKEY_PROVIDER_NAME)
print("======================================")




INVOKE: 
import requests, json

GATEWAY_URL = "PASTE_YOUR_GATEWAY_MCP_URL_HERE"  # e.g. https://xxxx.gateway.bedrock-agentcore.us-east-1.amazonaws.com/mcp

def mcp(method, params=None, _id=1):
    payload = {"jsonrpc": "2.0", "id": _id, "method": method}
    if params is not None:
        payload["params"] = params
    r = requests.post(GATEWAY_URL, json=payload, timeout=30)
    print("HTTP", r.status_code)
    print("RAW", r.text[:800])
    r.raise_for_status()
    return r.json()





tools_resp = mcp("tools/list", _id=1)
print(json.dumps(tools_resp, indent=2)[:3000])

tool_name = tools_resp["result"]["tools"][0]["name"]
print("✅ TOOL NAME:", tool_name)




call_resp = mcp(
    "tools/call",
    params={
        "name": "process_refund",
        "arguments": {"amount": 25, "reason": "damaged item"}
    },
    _id=2
)

print(json.dumps(call_resp, indent=2)[:4000])


